<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo App</title>
</head>
<style>
    #erreur{
        color: #aa0025;
    }
    .hidden{
        display: none;
    }
    body{
        padding: 15px;
    }
    ul{
        list-style: none;
        margin: 0;
        padding: 0;
    }
</style>
<body>
    <div class="form-container">
        <form id="form" action="/todos/add" method="POST">
            <input type="text" name="description" id="task-description">
            <input type="submit" value="Ajouter">
        </form>
    </div>
    <div id="error" class="hidden">Une erreur s'est produite</div>
    <ul id="todos">
        {% for d in data %}
        <li>
            <input class="check-completed" type="checkbox" {% if d.completed %}checked{% endif %}>
            {{ d.description }}
        </li>
        {% endfor %}
    </ul>
    <script>
        const checkBoxes = document.querySelectorAll('.check-completed');
        checkBoxes.forEach(elt => {
            elt.addEventListener('change', e => {
                console.log('event', e);
                const newCompleted = e.target.checked;
                fetch('/todos/set-completed', {
                    method : 'POST',
                    body : JSON.stringify({
                        'completed' : newCompleted
                    }),
                    headers: {
                        'Content-Type' : 'application/json'
                    }
                })
            })
        })
        document.getElementById('form').addEventListener('submit', (e) => {
            e.preventDefault();
            fetch('/todos/add', {
                method: 'POST',
                body: JSON.stringify({
                    'description': document.getElementById('task-description').value
                }),
                headers:{
                    'Content-Type': 'application/json'
                }
            })
            .then(function(response){
                console.log(response)
                return response.json();
            })
            .then(function(jsonResponse){
                console.log(jsonResponse);
                const liItem = document.createElement('LI');
                liItem.innerHTML = jsonResponse.description;
                document.getElementById('todos').appendChild(liItem);
                document.getElementById('error').className="hidden";
                
            })
            .catch(function(error){
                console.log(error);
                document.getElementById('error').className="";
            })
        });
    </script>
</body>
</html>